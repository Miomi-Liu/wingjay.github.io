title: 自己动手改造个人博客
date: 2017-06-08 12:12:37
permalink: rebuild-personal-blog
categories:
  - 个人博客
  - 一天变cool
tags:
  - GitHub
  - Blog
  - Hexo
  - 个人博客
  - 一天变cool
commentIssueId: 1  
---

个人博客不仅是个人写作的地方，更是一个展示自己个性、扩大个人影响力的产品。

之前我写过一篇《[如何在一天之内搭建以你自己名字为域名且具备cool属性的个人博客](http://www.jianshu.com/p/99665608d295)》帮助不少人从零开始搭建了自己的博客。而今天想做的是把博客当成个人产品来进行迭代开发，以更好地展示个人形象。

<!-- more -->

> 更新：利用脚本为即将发表的文章自动创建一个 Github issue。

下面我将介绍一些关于个人博客的新功能，以及实现功能的过程。[注：建议进入[原文阅读](http://wingjay.com/2017/06/08/rebuild-personal-blog/)，可以查看到功能的具体效果。本站搭建在 Hexo 平台上]
- 中英文自动添加空格
- 推荐相关文章
- 基于GitHub Issue来实现评论功能
- 个人简历页面
- RSS订阅


## 中英文自动添加空格
不少有追求的开发者在写博客时追求格式优雅，比如`中英文间隔`。为了达到这个目的，很多时候就不得不在写文时反复调整英文单词与中文的空格。

这里介绍一个小巧的插件：[Auto-Spacing](https://github.com/hexojs/hexo-filter-auto-spacing)，它会在 markdown 文章转化成 html 时，自动为中英文添加空格。

安装方法：
在项目根目录下，执行 
```
npm install hexo-filter-auto-spacing --save
```

执行完后可以在根目录的 `package.json` 里找到一行 

```
denpendency`:`"hexo-filter-auto-spacing": "^0.2.1"
```

**提醒**
使用这个工具要留意一点：如果你在文章里使用了中英文混合的url，如我本地的图片 `http://wingjay.com/img/我的博客.png`，它会变成 `http://wingjay.com/img/ 我的博客.png`，因此，这里推荐所有图片等资源的url都使用英文。

## 相关文章推荐
原生的 Hexo 等第三方博客框架并不能提供 `相关文章推荐` 的功能，而对于一款产品而言，增加用户的使用时间是非常好的。

博客也是，当一位读者读完你的某篇文章感觉不错时，再推荐一些相关的文章，读者点击的几率是非常大的。

在连续读完几遍文章后，读者便对你形成了基本的印象：xxx 作者在 Android 方面的 xxx 技术点有不少的研究，以后可以来多关注关注。

下面讲解下如何实现 `相关文章推荐` 功能。

基本思路是：
1. 改造 hexo theme 里的`博客模板`文件，在模板底部添加一块 html/swig 片段；
2. 利用 Hexo 提供的 `Helper` 功能，使用 `javascript` 去获取几篇相似文章的链接；
3. 此处的 `相似`，可以找出相同 tag 的文章，也可以通过其他指标来定义；
4. 找到了文章列表后，填充在文章模板底部即可。

具体代码实现如下：

0. 先阅读 Hexo 提供的`Helper`功能，https://hexo.io/zh-cn/api/helper.html
1. 向 `Helper` 里注册函数 `related_posts`，用来抓取相关文章列表。
进入博客目录的 `themes/next/scripts` 里面，创建 `related_posts.js` 文件，内容如下
```javascript
    hexo.extend.helper.register('related_posts', function(currentPost, allPosts){
        var relatedPosts = [];
        currentPost.tags.forEach(function (tag) {
            allPosts.forEach(function (post) {
                if (isTagRelated(tag.name, post.tags)) {
                    var relatedPost = {
                        title: post.title,
                        path: post.path,
                        weight: 1
                    };

                    var index = findItem(relatedPosts, 'path', post.path);

                    if (index != -1) {
                        relatedPosts[index].weight += 1;
                    } else{
                        if (currentPost.path != post.path) {
                            relatedPosts.push(relatedPost);
                        };
                    };
                };
            });
        });

        if (relatedPosts.length == 0) {return ''};

        var result = '<h3>相关文章：</h3><ul class="related-posts">';
        relatedPosts = relatedPosts.sort(compare('weight'));
        for (var i = 0; i < Math.min(relatedPosts.length, 10); i++) {
            result += '<li><a href="/' + relatedPosts[i].path + '">' + relatedPosts[i].title + '</a></li>';
        };
        result += '</ul>';

        // console.log(relatedPosts);
        return result;
    });

    hexo.extend.helper.register('echo', function(path){
      return path;
    });

    function isTagRelated (tagName, TBDtags) {
        var result = false;
        TBDtags.forEach(function (tag) {
            if (tagName == tag.name) {
                result = true;
            };
        })

        return result;
    }

    function findItem (arrayToSearch, attr, val) {
        for (var i = 0; i < arrayToSearch.length; i++) {
            if (arrayToSearch[i][attr] == val) {
                return i
            };
        };

        return -1;
    }

    function compare (attr) {
        return function (a, b) {
            var val1 = a[attr];
            var val2 = b[attr];
            return val2 - val1;
        }
    }
```
2. 修改文章模板 theme/next/layout/_macro/post.swig。在文章底部添加：
```
{% if not is_index %} // 不需要显示在首页。
	{{ related_posts(post, site.posts) }} // 调用 related_posts
{% endif %}
```
注意，如果是 ejs 文件，则要把`{ { }}`换成"<\%- \%>"格式，这是 swig 和 ejs 的语法差别。

重新 generate 即可以看到文章底部出现了相关文章推荐。如果想要修改UI，可以在上面的 `related_posts.js` 里返回的 html 片段里添加一些 css 即可。

## 基于GitHub Issue来实现评论功能
个人博客里的评论功能一直是个很麻烦的存在，博主也一直在寻找合适的解决方案。

“多说”挺好用的，但是今年关闭了；“disqus”是第二个选择，简洁美观，但tm国内经常不打开；“网易云跟帖”也不错，本来是个很好的选择，不过里面的广告留言超级多，过滤机制不好。

本来我都已经放弃了，不过突发奇想，既然我的整个博客都是架在 GitHub 上，那么能不能让 GitHub 来帮我管理评论呢？对于一条评论而言，要能够实现：
1. 创建评论
2. 展示评论
3. 能够过滤广告评论

然后，我想到了 GitHub Issue 和 GitHub API。

不过我几乎没见过国内有博主这么做，于是搜了些国外的文章，做了些调研，果然发现国外也有开发者做过这样的尝试，而且效果我感觉还不错。

具体有两种实现方案：
1. 读者直接在阅读个人博客时，直接登录 Github 并在文章页面进行评论；
2. 读者跳转到博客对应的 Github issue处，在 issue 下进行评论，文章展示时会实时获取评论数据。

第一处的用户体验比较好，但是要管理 Github 的第三方登录机制相对麻烦，而且我认为带来的好处没有那么明显。因此我采取了第二种方案，读者跳转到 GitHub Issue 进行评论，文章中利用 Github API 来拉取最新的评论数据。

可以参考文末的评论区，也可以尝试点击到 GitHub Issue 进行评论，给出建议。

实现代码如下：
1. 在 `themes/myNext/layout/_partials` 创建一个评论 html 片段：`github-comments.swig`，它会自动去 Github 拉取相关的评论，你可以更改`$.ajax("https://api.github.com/repos/wingjay/wingjay.github.io/issues/1/comments",`这句里的 issue url，放上你自己的Github地址。另外，评论里面的 UI 是我自己模仿 GitHub Issue 写的，就是为了保持一个一致性。
```
<!doctype html>
<html>
<div class="clearfix"></div>
<br>
<div id="comments">
<div class="post-header bg-{{site.default_post_color}}">
  <h1 class="h1 post-title">评论</h1>
</div>

<article class="post-content">
<p>本站评论搭建在 Github Issue 上，请前往 <a href="https://github.com/wingjay/wingjay.github.io/issues/1/{{page.commentIssueId}}">  此文issue</a> 进行评论。（你需要有 Github 账号）<br/>
Want to leave a comment? Visit <a href="https://github.com/wingjay/wingjay.github.io/issues/1/{{page.commentIssueId}}"> this post's issue page on GitHub</a> (you'll need a GitHub account).</p>
</article>
</div>

<style type="text/css">
.timeline-comment-wrapper {
    margin-top: 0;
    position: relative;
    padding-left: 60px;
    margin-top: 15px;
    margin-bottom: 15px;
    border-top: 2px solid #fff;
    border-bottom: 2px solid #fff;
}
.timeline-comment-avatar {
    float: left;
    margin-left: -60px;
    border-radius: 3px;
}
.avatar-parent-child {
    position: relative;
}
.timeline-comment-wrapper a {
    color: #0366d6;
    text-decoration: none;
    background-color: transparent;
}
.timeline-comment-wrapper .avatar {
    display: inline-block;
    overflow: hidden;
    line-height: 1;
    vertical-align: middle;
    border-radius: 3px;
}
.timeline-comment-wrapper .rounded-1 {
    border-radius: 3px !important;
}
.timeline-comment.current-user {
    border-color: #c0d3eb;
}
.timeline-comment {
    position: relative;
    background-color: #fff;
    border: 1px solid #d1d5da;
    border-radius: 3px;
}
.timeline-comment.current-user .timeline-comment-header {
    background-color: #f1f8ff;
    border-bottom-color: #c0d3eb;
}
.timeline-comment-header {
    padding-right: 15px;
    padding-left: 15px;
    color: #586069;
    background-color: #f6f8fa;
    border-bottom: 1px solid #d1d5da;
    border-top-left-radius: 3px;
    border-top-right-radius: 3px;
}
.timeline-comment-header-text {
    padding-top: 10px;
    padding-bottom: 10px;
}
.timeline-comment-header h3 {
    margin-top: 0px;
    margin-bottom: 0px;
}
.timeline-comment-header-text .post-meta {
    margin-left: 6px;
}
.timeline-comment article p {
    margin: 0px;
}
.text-normal {
    font-weight: normal !important;
}
.f5 {
    font-size: 14px !important;
}
</style>



<script type="text/javascript">
  function loadComments(data) {
    for (var i=0; i<data.length; i++) {
      var cuser = data[i].user.login;
      var cuserlink = data[i].user.html_url;
      var avatarlink = data[i].user.avatar_url;
      var clink = data[i].html_url;
      var cbody = data[i].body_html;
      var cavatarlink = data[i].user.avatar_url;      
      var cdate = new Date(data[i].created_at);
      var dopts = { month: 'short', day: 'numeric', year: 'numeric' }

      $("#comments").append('<div class="timeline-comment-wrapper"><div class="avatar-parent-child timeline-comment-avatar"><a href="' + cuserlink +'"><img width="44" height="44" class="avatar rounded-1" src="' + avatarlink + '"></a></div><div class="timeline-comment current-user"><div class="timeline-comment-header"><h3 class="timeline-comment-header-text text-normal f5"><strong>' + cuser + '</strong><span class="post-meta">' + cdate.toLocaleDateString("en", dopts) + '</span></h3></div><div style="display: block !important; padding: 15px;"><article class="post-content">' + cbody + '</article></div></div></div>');
    }
  }
  console.log('start load');
  $.ajax("https://api.github.com/repos/wingjay/wingjay.github.io/issues/1/comments", {
    headers: {Accept: "application/vnd.github.v3.html+json"},
    dataType: "json",
    success: function(msg){
      console.log(msg);
      loadComments(msg);
   }
  });
</script>
</html>
```
2. 然后把上面的html片段放入文章模板里面。`themes/myNext/layout/_macro/post.swig`
```
{% if page.commentIssueId %}
  {% include '../_partials/github-comments.swig' %}
{% endif %}
```
3. 由于上面的 js 代码里用到了 jQuery 的 ajax 语法，因此，还要在 `themes/myNext/layout/_partials/head.swig` 加载 jQuery，此处使用的是国内的 CDN url，加载时间 30ms。
```
{% if page.commentIssueId %}
  <script src="https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
{% endif %}
```
4. **更新内容** 通过脚本，自动在 Github 上为该篇文章创建一个 Issue，得到该 Issue ID，设置为该文章的 commentIssueId 值即可。
  - 指定文章路径，脚本自动读取 commentIssueId 值，若为空，则开始创建 Issue;
  - 利用 curl 和 Github API 自动创建一个 Issue。其中 YOUR_TOKEN 需要在 Github 的 `Personal access tokens` 里生成一个具备 repo 权限的 token。
  ```
  curl -H "Content-Type: application/json" -u wingjay:YOUR_TOKEN -X POST -d '{"title": "test"}' https://api.github.com/repos/wingjay/wingjay.github.io/issues
  ```
  - 上面 POST 请求的返回值里的 `number` 值即为需要的 commentIssueId。通过脚本把这个 commentIssueId 添加到原文章中
  - 最后 deploy 即可。
  
上面的步骤都是通过[这个脚本](https://github.com/wingjay/hacker_scripts/blob/master/hexo_deploy.sh)实现的，有兴趣的可以看下。


## 个人简历页面
对于一个优秀的博主而言，每天会有很多开发者进入到他的博客。

而无论出于职业生涯还是个人影响力的角度考虑，在博客里放置个人简历是一个很好的展示自己的机会。

下面我们来利用 `hexo` 的 `page` 功能来创建一个新页面，然后用 markdown 来填充这个简历页面。

1. 利用 `hexo new page "resume"`，可以看到 `source` 文件夹下出现了 `resume` 目录，里面有一个 `index.md` 文件；
2. 在 `themes/next/_config.yml` 里的 `menu:` 下添加 `resume: /resume`，它会在首页创建一个新的 menu: resume 入口；
3. 在 `index.md` 文件里填写自己的简历即可。

最终效果参考本人[简历](/resume)
  
## RSS订阅
目前很多人喜欢用 RSS 阅读器来实时更新某些作者的文章，如果你希望有更多死忠粉，那 RSS 是非常好的渠道把你的文章快速传达给你的读者。

这里我们利用插件 [`hexo-generator-feed`](https://github.com/hexojs/hexo-generator-feed) 来实现这个功能。

1. 安装
npm install hexo-generator-feed --save
2. 修改 _config.yml，具体设置可以参考官方链接里的指示
```
feed:
  type: atom
  path: atom.xml
  limit: 20
  hub:
  content:
```
3. 在 themes/next/_config.yml 里的 menu 添加 
rss: /atom.xml
4. 在 themes/next/languages/zh-Hans.yml 里的 menu 添加中文翻译
rss: RSS

重新 generate 一下即可看到。


## 总结
好了，这次的功能性博客改造告一段落，欢迎读者提出意见想法。

之后还会对博客做一些加载速度、图片及js文件加载方式等的优化，偏向于流畅性和加载方面。

下次见。

谢谢。

wingjay

http://wingjay.com

![](https://avatars0.githubusercontent.com/u/9619875?v=3&s=460)


## 参考文章
《[Hexo相关文章的代码实现](https://ethanblog.com/tech/hexo-related-posts.html)》
《[next主题的模板引擎swig语法介绍](http://jinfang.oschina.io/posts/124966c9/)》
《[Using GitHub to host blog comments: a working example](http://hydroecology.net/using-github-to-host-blog-comments/)》
《[GitHub hosted comments for GitHub hosted blogs](http://ivanzuzak.info/2011/02/18/github-hosted-comments-for-github-hosted-blogs.html)》
《[博客优化点汇总](https://imququ.com/post/summary-of-my-blog-optimization.html)》
